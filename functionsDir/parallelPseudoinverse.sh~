#!/bin/tcsh
unset noclobber

#* Description: Determines the transformation matrices between the given BPM, and all other BPM downstream
#* Argument: $1 - BPMONE - BPM to use as a reference point for all SVD pseudoinverse transformations
#* Argument: $2 - DESIGNBEAMLINE - Name of the unmodified 'design' beamline
#* Argument: $3 - MODIFIEDBEAMLINE - Modified beamline whose only purpose in this script is to provide a name for the data file containing the M values
#* Argument: $4 - VERTICLE - Boolean 1 or 0 which represents whether the transformation is verticle or horizontal
#* Example: runPPSSPseudoinverse.sh IPM1S03 unkicked modified 1
#* Further Comments: All of the transformation matrix information is stored in the ellipseDir folder
#* Main Output: mValues$TRIAL.dat

# Store variables as command input or defaults
set BPMONE = `echo $1 | awk '{print $1}'`
set BPMTWO = `echo $1 | awk '{print $2}'`
set S = `echo $1 | awk '{print $3}'`
set TRIAL = `echo $1 | awk '{print $4}'`

# Reformat ellipseA.dat and ellipseB.dat in a MATLAB readable way
#* Output: ellipseA$TRIAL.fin ellipseB$TRIAL.fin
$FPATH/formatEllipses.sh $BPMONE $BPMTWO $TRIAL

# Perform SVD and pseduo inverse on the matrixes
#* Output: ellipseA2$TRIAL.fin
python $FPATH/determineTransformationMatrix.py $TRIAL $ELLIPSEPATH

# Calculate determinant to make sure the calculation was performed correctly, should be ~1
echo `cat $ELLIPSEPATH/ellipseC$TRIAL.fin` >! $ELLIPSEPATH/temp$TRIAL.dat
set DETERMINANT = `cat $ELLIPSEPATH/temp$TRIAL.dat | awk '{print ($1*$4 - $2*$3)}'`

# Format the in the form: $BPMTWO $S M1 M2 M3 M4 Determinant: $DETERMINANT
#* Output: mValues$TRIAL.dat
echo "$BPMTWO $S `cat $ELLIPSEPATH/ellipseC$TRIAL.fin` Determinant: $DETERMINANT" >! "$ELLIPSEPATH/mValues$TRIAL.dat"
rm $ELLIPSEPATH/ellipse*$TRIAL.fin $ELLIPSEPATH/temp$TRIAL.dat >& /dev/null
